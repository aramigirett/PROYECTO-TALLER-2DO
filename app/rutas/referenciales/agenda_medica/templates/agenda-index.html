{% extends 'base.html' %}

{% block titulo %}
Gestionar Agenda Medico
{% endblock %}

{% block contenido %}
<div class="container mt-4">
  <h3>Agenda Médicos</h3>

  <!-- Tarjeta -->
  <div class="card">
      <div class="card-header">
          <button type="button" class="btn btn-outline-info" id="btnAgregar">Agregar</button>
      </div>
      <div class="card-body">
          <!-- <div class="table-responsive"> -->
              <table class="table table-striped" id="tblAgenda">
                  <thead>
                      <tr>
                          <th>Médico</th>
                          <th>Día</th>
                          <th>Fecha Agenda</th>
                          <th>Hora Inicio</th>
                          <th>Hora Final</th>
                          <th>Duración (minutos)</th>
                          <th>Acciones</th>
                      </tr>
                  </thead>
                  <tbody></tbody>
              </table>
          <!-- </div> -->
      </div>
  </div>

  <!-- Modal Formulario -->
  <div class="modal fade" id="modalFormulario" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <!-- Modal Header -->
              <div class="modal-header">
                  <h4 class="modal-title" id="modalTitle"></h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>

              <!-- Modal Body -->
              <div class="modal-body">
                  <div class="form-group">
                      <input type="hidden" id="txtIdAgenda">
                      <input type="hidden" id="idMedico">

                      <label for="txtMedico">Médico:</label>
                      <input type="text" class="form-control" placeholder="Haga clic para asignar un médico" id="txtMedico">

                      <input type="hidden" id="txtIdDia">
                      <label for="txtDia">Día:</label>
                      <input type="text" class="form-control" placeholder="Ingrese los días disponibles" id="txtDia">

                      <label for="txtfecha_agenda" class="form-label">Fecha de la Agenda</label>
                      <input type="date" class="form-control" id="txtfecha_agenda">

                      <label for="txthora_inicio" class="form-label">Hora de Inicio</label>
                      <input type="time" class="form-control" id="txthora_inicio">

                      <label for="txthora_final" class="form-label">Hora de Finalización</label>
                      <input type="time" class="form-control" id="txthora_final">

                      <label for="txtduracion" class="form-label">Duración (minutos)</label>
                      <input type="number" class="form-control" id="txtduracion">
                  </div>
              </div>

              <!-- Modal Footer -->
              <div class="modal-footer">
                  <button type="button" class="btn btn-success" id="btnGuardar">Guardar</button>
                  <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Modal Buscar Médico -->
<div class="modal fade" id="modalBuscarMedico" tabindex="-1" aria-labelledby="modalMedicoTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
          <div class="modal-header">
              <h4 class="modal-title" id="modalMedicoTitle">Seleccionar Médico</h4>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <div class="table-responsive">
                  <table class="table table-striped table-bordered w-100" id="tblMedico">
                      <thead>
                          <tr>
                              <th>Nombre</th>
                              <th>Apellido</th>
                              <th>Especialidad</th>
                              <th>Seleccionar</th>  <!-- Agregar la columna 'Seleccionar' -->
                          </tr>
                      </thead>
                      <tbody></tbody>
                  </table>
              </div>
          </div>
      </div>
  </div>
</div>
  <!-- Alerta de Registro Exitoso -->
  <div class="row mt-4 d-none" id="rowAlerta">
      <div class="col-md-12">
          <div class="alert alert-success">
              <strong>Registro Exitoso!</strong>
              <div class="row" id="mostrarAlerta"></div>
          </div>
      </div>
  </div>
</div>

{% endblock %}

{% block js %}
<script>
  const initDatatable = () => {
    $('#tblAgenda').DataTable ({
       language: {
        url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
       },
       ajax:'/api/v1/agendas',
       columns: [
          {data: 'medico'},
          {data: 'fecha_agenda'},
          {data: 'hora_inicio'},
          {data: 'hora_final'},
          {data: 'duracion'},
          {data: function(row) {
              return `<button type="button" name="btn_editar" class="btn btn-success" data-id="${row.id_agenda_medica}">Editar</button>
                       <button type="button" name="btn_eliminar" class="btn btn-danger" data-id="${row.id_agenda_medica}">Eliminar</button>`;
          }}
        ]
    });
  }

  const initDatatableMedico = () => {
    $('#tblMedico').DataTable({
        language: {
            url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
        },
        ajax: '/api/v1/medicos',
        columns: [
            { data: 'nombre' },
            { data: 'apellido' },
            { data: 'especialidad' },
            { data: function(row) {
                return `<button type="button" name="btn_seleccionar_medico" class="btn btn-primary" data-id="${row.id}" data-nombre="${row.nombre}" data-apellido="${row.apellido}" data-especialidad="${row.especialidad}"><i class="fa fa-check"></i> Seleccionar</button>`;
            }}
        ]
    });

    $('#tblMedico').on('click', 'button[name="btn_seleccionar_medico"]', function () {
        const idMedico = $(this).data('id');
        const medico = $(this).data('nombre');
        const apellido = $(this).data('apellido');
        const especialidad = $(this).data('especialidad');
        $('#txtMedico').val(medico+" "+apellido+" "+ especialidad);
        $('#id_medico').val(idMedico);  
        $('#modalBuscarMedico').modal('hide'); 
    });
};

  const buscarMedico = () => {
    $('#txtMedico').on('click', function () {
      $('#modalMedicoTitle').text("Seleccionar Médico");
      $('#modalBuscarMedico').modal();
    });
  }

  const agregar = () => {
    $('#btnAgregar').on('click', function () {
       $('#modalTitle').text("Agregar Agenda");
       $('#txtIdAgenda').val("");
       $('#id_medico').val("");
       $('#txtDia').val("");
       $('#txtfecha_agenda').val("");
       $('#txthora_inicio').val("");
       $('#txthora_final').val("");
       $('#txtduracion').val("");
       $('#modalFormulario').modal();
    });
  }

  const guardar = () => {
    $('#btnGuardar').on('click', function() {
      const idAgenda = $('#txtIdAgenda').val();
      const id_medico = $('#id_medico').val();
      const nuevafecha_agenda = $('#txtfecha_agenda').val();
      const nuevohora_inicio = $('#txthora_inicio').val();
      const nuevahora_final = $('#txthora_final').val();
      const nuevaduracion = $('#txtduracion').val();
      const tabla = $('#tblAgenda').DataTable();

      if(idAgenda) {

        fetch(`/api/v1/agendas/${idAgenda}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id_medico: id_medico, fecha_agenda: nuevafecha_agenda, hora_inicio: nuevohora_inicio, hora_final: nuevahora_final, duracion: nuevaduracion })
        })
        .then(resp => resp.json())
        .then(data => {
          if(data && !data.error && data.success) {
            tabla.ajax.reload();
            Swal.fire("Actualizado", "La agenda ha sido actualizada correctamente.", "success");
          } else {
            Swal.fire(data.error);
          }
        }).catch(err => {
          console.error(err);
          Swal.fire("Error", "Ocurrió un error al actualizar la agenda.", "error");
        });
      } else {

        fetch(`/api/v1/agendas`, {
          method:'POST',
          headers: { 
            'Content-Type': 'application/json'
         }, body: JSON.stringify({ id_medico: id_medico, fecha_agenda: nuevafecha_agenda, hora_inicio: nuevohora_inicio, hora_final: nuevahora_final, duracion: nuevaduracion  })
        })
        .then(resp => resp.json())
        .then(data => {
          if(data && !data.error && data.success) {
            tabla.ajax.reload();
            Swal.fire("Agregado", "La agenda ha sido agregada correctamente.", "success");
          } else {
            Swal.fire(data.error);
          }
        }).catch(err => {
          console.error(err);
          Swal.fire("Error", "Ocurrió un error al guardar la agenda.", "error");
        });
      }
      $('#modalFormulario').modal("hide");
    });
  }

  const eliminar = () => {
    $('#tblAgenda').on('click', '.btn-eliminar', function() {
      const id = $(this).data('id');
      Swal.fire({
        title: "¿Deseas eliminar esta agenda?",
        showCancelButton: true,
        confirmButtonText: "Sí",
        cancelButtonText: "No",
      }).then(result => {
        if (result.isConfirmed) {
          fetch(`/api/v1/agendas/${idAgenda}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
          })
          .then(resp => resp.json())
          .then(data => {
            if (data.success) {
              $('#tblAgenda').DataTable().ajax.reload();
              Swal.fire("Eliminado", "La agenda ha sido eliminada correctamente.", "success");
            } else {
              Swal.fire("Error", "Ocurrió un error al eliminar la agenda.", "error");
            }
          });
        }
      });
    });
  };

  const addEvents = () => {
    agregar();
    guardar();
  
    eliminar();
    buscarMedico();
  };

  $(function () {
    initDatatable();
    initDatatableMedico();
    addEvents();
  });
</script>
{% endblock %}