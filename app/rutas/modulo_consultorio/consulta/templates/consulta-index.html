{% extends 'base.html' %}

{% block titulo %}
Gestión de Consultas Médicas
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">

  <!-- ============================================ -->
  <!-- TARJETAS DE ESTADÍSTICAS - DISEÑO MÉDICO -->
  <!-- ============================================ -->
  <div class="row mb-4">
    <!-- Consultas de Hoy -->
    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card card-medical shadow-medical h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="icon-medical bg-blue">
              <i class="fas fa-calendar-day"></i>
            </div>
            <div class="ml-3 flex-grow-1">
              <div class="text-xs font-weight-bold text-uppercase mb-1 text-medical-blue">
                Consultas de Hoy
              </div>
              <div class="h4 mb-0 font-weight-bold text-gray-800" id="consultasHoy">0</div>
            </div>
          </div>
        </div>
        <div class="card-footer-medical bg-blue"></div>
      </div>
    </div>

    <!-- En Seguimiento -->
    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card card-medical shadow-medical h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="icon-medical bg-warning">
              <i class="fas fa-clock"></i>
            </div>
            <div class="ml-3 flex-grow-1">
              <div class="text-xs font-weight-bold text-uppercase mb-1 text-medical-warning">
                En Seguimiento
              </div>
              <div class="h4 mb-0 font-weight-bold text-gray-800" id="consultasEnSeguimiento">0</div>
            </div>
          </div>
        </div>
        <div class="card-footer-medical bg-warning"></div>
      </div>
    </div>

    <!-- Finalizadas -->
    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card card-medical shadow-medical h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="icon-medical bg-green">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="ml-3 flex-grow-1">
              <div class="text-xs font-weight-bold text-uppercase mb-1 text-medical-green">
                Finalizadas
              </div>
              <div class="h4 mb-0 font-weight-bold text-gray-800" id="consultasFinalizadas">0</div>
            </div>
          </div>
        </div>
        <div class="card-footer-medical bg-green"></div>
      </div>
    </div>

    <!-- Total Consultas -->
    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card card-medical shadow-medical h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="icon-medical bg-info">
              <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="ml-3 flex-grow-1">
              <div class="text-xs font-weight-bold text-uppercase mb-1 text-medical-info">
                Total Consultas
              </div>
              <div class="h4 mb-0 font-weight-bold text-gray-800" id="totalConsultas">0</div>
            </div>
          </div>
        </div>
        <div class="card-footer-medical bg-info"></div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- CARD PRINCIPAL: TABLA DE CONSULTAS -->
  <!-- ============================================ -->
  <div class="card card-medical shadow-medical">
    
    <!-- HEADER CON GRADIENTE MÉDICO -->
    <div class="card-header card-header-medical">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0 font-weight-bold text-white">
          <i class="fas fa-stethoscope mr-2"></i> Gestión de Consultas Médicas
        </h5>
        <button type="button" class="btn btn-medical-white" id="btnAgregar">
          <i class="fas fa-plus-circle mr-1"></i> Nueva Consulta
        </button>
      </div>
    </div>

    <!-- BODY: TABLA -->
    <div class="card-body p-3">
      <div class="table-responsive">
        <table class="table table-medical table-hover align-middle" id="tblConsultas">
          <thead>
            <tr>
              <th><i class="fas fa-calendar mr-1"></i> Fecha</th>
              <th><i class="fas fa-clock mr-1"></i> Hora</th>
              <th><i class="fas fa-user mr-1"></i> Paciente</th>
              <th><i class="fas fa-user-md mr-1"></i> Médico</th>
              <th><i class="fas fa-door-open mr-1"></i> Consultorio</th>
              <th><i class="fas fa-hourglass-half mr-1"></i> Duración</th>
              <th><i class="fas fa-flag mr-1"></i> Estado</th>
              <th><i class="fas fa-cogs mr-1"></i> Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- ============================================ -->
<!-- MODAL: FORMULARIO CONSULTA -->
<!-- ============================================ -->
<div class="modal fade" id="modalFormulario" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content modal-medical">

      <!-- HEADER CON GRADIENTE -->
      <div class="modal-header modal-header-medical">
        <h5 class="modal-title font-weight-bold text-white">
          <i class="fas fa-stethoscope mr-2"></i> <span id="modalTitle">Nueva Consulta Médica</span>
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <!-- BODY -->
      <div class="modal-body bg-medical-light p-4">
        <input type="hidden" id="txtIdConsulta">

        <!-- SECCIÓN: INFORMACIÓN DEL PACIENTE -->
        <div class="section-medical mb-4">
          <div class="section-header-medical">
            <i class="fas fa-user-circle"></i> Información del Paciente
          </div>
          <div class="section-body-medical">
            <div class="row">
              <div class="col-md-6 mb-3">
                <input type="hidden" id="id_paciente">
                <label class="label-medical">Paciente <span class="text-danger">*</span></label>
                <div class="input-group input-group-medical">
                  <input type="text" id="txtPaciente" class="form-control form-control-medical" 
                         placeholder="Click para seleccionar" readonly required>
                  <div class="input-group-append">
                    <span class="input-group-text input-group-text-medical">
                      <i class="fas fa-search"></i>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCIÓN: ASIGNACIÓN MÉDICA -->
        <div class="section-medical mb-4">
          <div class="section-header-medical">
            <i class="fas fa-user-md"></i> Asignación Médica
          </div>
          <div class="section-body-medical">
            <div class="row">
              <div class="col-md-6 mb-3">
                <input type="hidden" id="id_medico">
                <label class="label-medical">Médico <span class="text-danger">*</span></label>
                <div class="input-group input-group-medical">
                  <input type="text" id="txtMedico" class="form-control form-control-medical" 
                         placeholder="Click para seleccionar" readonly required>
                  <div class="input-group-append">
                    <span class="input-group-text input-group-text-medical">
                      <i class="fas fa-search"></i>
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-6 mb-3">
                <input type="hidden" id="id_consultorio">
                <label class="label-medical">Consultorio <span class="text-danger">*</span></label>
                <div class="input-group input-group-medical">
                  <input type="text" id="txtConsultorio" class="form-control form-control-medical" 
                         placeholder="Click para seleccionar" readonly required>
                  <div class="input-group-append">
                    <span class="input-group-text input-group-text-medical">
                      <i class="fas fa-search"></i>
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-6 mb-3">
                <input type="hidden" id="id_funcionario">
                <label class="label-medical">Funcionario (Opcional)</label>
                <div class="input-group input-group-medical">
                  <input type="text" id="txtFuncionario" class="form-control form-control-medical" 
                         placeholder="Click para seleccionar" readonly>
                  <div class="input-group-append">
                    <span class="input-group-text input-group-text-medical">
                      <i class="fas fa-search"></i>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCIÓN: PROGRAMACIÓN -->
        <div class="section-medical mb-4">
          <div class="section-header-medical">
            <i class="fas fa-calendar-alt"></i> Programación de la Consulta
          </div>
          <div class="section-body-medical">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="label-medical">Fecha <span class="text-danger">*</span></label>
                <input type="date" id="fecha_cita" class="form-control form-control-medical" required>
              </div>

              <div class="col-md-4 mb-3">
                <label class="label-medical">Hora <span class="text-danger">*</span></label>
                <input type="time" id="hora_cita" class="form-control form-control-medical" required>
              </div>

              <div class="col-md-4 mb-3">
                <label class="label-medical">Duración (min)</label>
                <input type="number" id="duracion_minutos" class="form-control form-control-medical" 
                       placeholder="30" min="1">
              </div>

              <div class="col-md-6 mb-3">
                <label class="label-medical">Estado</label>
                <select id="estado" class="form-control form-control-medical">
                  <option value="programada">📅 Programada</option>
                  <option value="en_proceso">⏳ En Proceso</option>
                  <option value="finalizada">✅ Finalizada</option>
                  <option value="cancelada">❌ Cancelada</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-medical-primary" id="btnGuardar">
          <i class="fas fa-save mr-1"></i> Guardar Consulta
        </button>
        <button type="button" class="btn btn-medical-secondary" data-dismiss="modal">
          <i class="fas fa-times mr-1"></i> Cancelar
        </button>
      </div>

    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- MODAL: DETALLES DE CONSULTA -->
<!-- ============================================ -->
<div class="modal fade" id="modalDetalles" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
    <div class="modal-content modal-medical">
      
      <!-- HEADER -->
      <div class="modal-header modal-header-medical-green">
        <h5 class="modal-title font-weight-bold text-white">
          <i class="fas fa-file-medical-alt mr-2"></i> Detalles de Consulta Médica
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <!-- BODY -->
      <div class="modal-body p-4">
        <input type="hidden" id="idConsultaDetalle">
        
        <!-- Información de la consulta -->
        <div class="alert alert-medical-info">
          <i class="fas fa-info-circle mr-2"></i>
          <strong>Información de la Consulta</strong><br>
          <span id="infoConsulta"></span>
        </div>

        <!-- BOTONES PRINCIPALES CON ESTILO MÉDICO -->
        <div class="mb-4">
          <button type="button" class="btn btn-medical-success mr-2 mb-2" id="btnVerEditarFichaMedica">
            <i class="fas fa-file-medical mr-1"></i> Ver/Editar Ficha Médica
          </button>
          <button type="button" class="btn btn-medical-primary mr-2 mb-2" id="btnGestionarDiagnosticos">
            <i class="fas fa-stethoscope mr-1"></i> Gestionar Diagnósticos
          </button>
          <button type="button" class="btn btn-medical-warning mb-2" id="btnRegistrarTratamientos">
            <i class="fas fa-pills mr-1"></i> Registrar Tratamientos
          </button>
        </div>

        <hr class="hr-medical">

        <!-- FORMULARIO: AGREGAR DETALLE CLÍNICO -->
        <div class="section-medical mb-4">
          <div class="section-header-medical">
            <i class="fas fa-notes-medical"></i> Agregar Detalle Clínico
          </div>
          <div class="section-body-medical">
            <div class="row">
              <div class="col-md-6 mb-3">
                <input type="hidden" id="id_sintoma">
                <label class="label-medical">Síntoma <span class="text-danger">*</span></label>
                <div class="input-group input-group-medical">
                  <input type="text" id="txtSintoma" class="form-control form-control-medical" 
                         placeholder="Click para seleccionar" readonly required>
                  <div class="input-group-append">
                    <span class="input-group-text input-group-text-medical">
                      <i class="fas fa-search"></i>
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-md-6 mb-3">
                <label class="label-medical">Pieza Dental</label>
                <input type="text" id="pieza_dental" class="form-control form-control-medical" 
                       placeholder="Ej: 18, 21, 4.6">
              </div>

              <div class="col-md-12 mb-3">
                <label class="label-medical">Diagnóstico <span class="text-danger">*</span></label>
                <textarea id="diagnostico" class="form-control form-control-medical" rows="2" 
                          placeholder="Diagnóstico general..." required></textarea>
              </div>

              <div class="col-md-12 mb-3">
                <label class="label-medical">Tratamiento <span class="text-danger">*</span></label>
                <textarea id="tratamiento" class="form-control form-control-medical" rows="2" 
                          placeholder="Tratamiento general..." required></textarea>
              </div>

              <div class="col-md-12 mb-3">
                <label class="label-medical">Procedimiento</label>
                <textarea id="procedimiento" class="form-control form-control-medical" rows="2" 
                          placeholder="Procedimiento realizado..."></textarea>
              </div>
            </div>

            <button type="button" class="btn btn-medical-success" id="btnAgregarDetalle">
              <i class="fas fa-plus-circle mr-1"></i> Agregar Detalle
            </button>
          </div>
        </div>

        <!-- TABLA DE DETALLES REGISTRADOS -->
        <div class="section-medical">
          <div class="section-header-medical">
            <i class="fas fa-list"></i> Detalles Registrados
          </div>
          <div class="section-body-medical">
            <div class="table-responsive">
              <table class="table table-medical table-sm" id="tblDetalles">
                <thead>
                  <tr>
                    <th>Síntoma</th>
                    <th>Pieza Dental</th>
                    <th>Diagnóstico</th>
                    <th>Tratamiento</th>
                    <th>Procedimiento</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-medical-secondary" data-dismiss="modal">
          <i class="fas fa-times mr-1"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- MODAL: FICHA MÉDICA -->
<!-- ============================================ -->
<div class="modal fade" id="modalFichaMedica" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
    <div class="modal-content modal-medical">
      
      <!-- HEADER -->
      <div class="modal-header modal-header-medical-green">
        <h5 class="modal-title font-weight-bold text-white">
          <i class="fas fa-file-medical mr-2"></i> Ficha Médica de Consulta
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <!-- BODY -->
      <div class="modal-body p-4">
        <input type="hidden" id="idConsultaFicha">
        <input type="hidden" id="idFichaMedicaExistente">
        
        <!-- SIGNOS VITALES -->
        <div class="section-medical mb-4">
          <div class="section-header-medical">
            <i class="fas fa-heartbeat"></i> Signos Vitales
          </div>
          <div class="section-body-medical">
            <div class="row">
              <div class="col-md-3 mb-3">
                <label class="label-medical">Presión Arterial</label>
                <input type="text" id="presion_arterial" class="form-control form-control-medical" 
                       placeholder="120/80">
              </div>
              <div class="col-md-3 mb-3">
                <label class="label-medical">Temperatura (°C)</label>
                <input type="number" id="temperatura" class="form-control form-control-medical" 
                       step="0.1" placeholder="36.5">
              </div>
              <div class="col-md-3 mb-3">
                <label class="label-medical">Frec. Cardíaca</label>
                <input type="number" id="frecuencia_cardiaca" class="form-control form-control-medical" 
                       placeholder="72">
              </div>
              <div class="col-md-3 mb-3">
                <label class="label-medical">Frec. Respiratoria</label>
                <input type="number" id="frecuencia_respiratoria" class="form-control form-control-medical" 
                       placeholder="16">
              </div>
              <div class="col-md-4 mb-3">
                <label class="label-medical">Peso (kg)</label>
                <input type="number" id="peso" class="form-control form-control-medical" 
                       step="0.1" placeholder="70.5">
              </div>
              <div class="col-md-4 mb-3">
                <label class="label-medical">Talla (cm)</label>
                <input type="number" id="talla" class="form-control form-control-medical" 
                       step="0.1" placeholder="175">
              </div>
              <div class="col-md-4 mb-3">
                <label class="label-medical">IMC (calculado)</label>
                <input type="text" id="imc" class="form-control form-control-medical" readonly>
              </div>
            </div>
          </div>
        </div>

        <!-- EXAMEN FÍSICO -->
        <div class="section-medical mb-4">
          <div class="section-header-medical">
            <i class="fas fa-user-check"></i> Examen Físico
          </div>
          <div class="section-body-medical">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="label-medical">Examen Físico General</label>
                <textarea id="examen_fisico_general" class="form-control form-control-medical" rows="4"></textarea>
              </div>
              <div class="col-md-6 mb-3">
                <label class="label-medical">Examen Bucal</label>
                <textarea id="examen_bucal" class="form-control form-control-medical" rows="4"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- OBSERVACIONES -->
        <div class="section-medical">
          <div class="section-header-medical">
            <i class="fas fa-clipboard"></i> Observaciones del Médico
          </div>
          <div class="section-body-medical">
            <textarea id="observaciones_medico" class="form-control form-control-medical" rows="3"></textarea>
          </div>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-medical-success" id="btnGuardarFichaMedica">
          <i class="fas fa-save mr-1"></i> Guardar Ficha Médica
        </button>
        <button type="button" class="btn btn-medical-secondary" data-dismiss="modal">
          <i class="fas fa-times mr-1"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- MODALES DE SELECCIÓN (Igual que antes) -->
<!-- ============================================ -->

<!-- Modal Paciente -->
<div class="modal fade" id="modalBuscarPaciente" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content modal-medical">
      <div class="modal-header modal-header-medical">
        <h5 class="modal-title font-weight-bold text-white">
          <i class="fas fa-user mr-2"></i> Seleccionar Paciente
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-medical table-hover w-100" id="tblPaciente">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Cédula</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Médico -->
<div class="modal fade" id="modalBuscarMedico" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content modal-medical">
      <div class="modal-header modal-header-medical">
        <h5 class="modal-title font-weight-bold text-white">
          <i class="fas fa-user-md mr-2"></i> Seleccionar Médico
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-medical table-hover w-100" id="tblMedico">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Especialidad</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Consultorio -->
<div class="modal fade" id="modalBuscarConsultorio" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content modal-medical">
      <div class="modal-header modal-header-medical">
        <h5 class="modal-title font-weight-bold text-white">
          <i class="fas fa-door-open mr-2"></i> Seleccionar Consultorio
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-medical table-hover w-100" id="tblConsultorio">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Funcionario -->
<div class="modal fade" id="modalBuscarFuncionario" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content modal-medical">
      <div class="modal-header modal-header-medical">
        <h5 class="modal-title font-weight-bold text-white">
          <i class="fas fa-user-tie mr-2"></i> Seleccionar Funcionario
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-medical table-hover w-100" id="tblFuncionario">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Cargo</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Síntoma -->
<div class="modal fade" id="modalBuscarSintoma" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content modal-medical">
      <div class="modal-header modal-header-medical">
        <h5 class="modal-title font-weight-bold text-white">
          <i class="fas fa-notes-medical mr-2"></i> Seleccionar Síntoma
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-medical table-hover w-100" id="tblSintoma">
            <thead>
              <tr>
                <th>Descripción</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Librerías -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<!-- ============================================ -->
<!-- ESTILOS CSS MÉDICO/CLÍNICO PROFESIONAL -->
<!-- ============================================ -->
<style>
/* ========================================
   VARIABLES DE COLOR MÉDICO
   ======================================== */
:root {
  --medical-blue: #1565C0;
  --medical-blue-dark: #0D47A1;
  --medical-blue-light: #E3F2FD;
  --medical-green: #2E7D32;
  --medical-green-dark: #1B5E20;
  --medical-green-light: #E8F5E9;
  --medical-gray: #455A64;
  --medical-gray-light: #ECEFF1;
  --medical-warning: #F57C00;
  --medical-warning-light: #FFF3E0;
  --medical-white: #FFFFFF;
  --medical-shadow: 0 2px 10px rgba(0,0,0,0.08);
  --medical-shadow-hover: 0 4px 20px rgba(0,0,0,0.15);
}

/* ========================================
   TARJETAS DE ESTADÍSTICAS
   ======================================== */
.card-medical {
  border: none;
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.3s ease;
  background: var(--medical-white);
}

.card-medical:hover {
  transform: translateY(-5px);
  box-shadow: var(--medical-shadow-hover);
}

.shadow-medical {
  box-shadow: var(--medical-shadow);
}

.icon-medical {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
}

.icon-medical.bg-blue {
  background: linear-gradient(135deg, var(--medical-blue) 0%, var(--medical-blue-dark) 100%);
}

.icon-medical.bg-green {
  background: linear-gradient(135deg, var(--medical-green) 0%, var(--medical-green-dark) 100%);
}

.icon-medical.bg-warning {
  background: linear-gradient(135deg, var(--medical-warning) 0%, #E65100 100%);
}

.icon-medical.bg-info {
  background: linear-gradient(135deg, #0288D1 0%, #01579B 100%);
}

.card-footer-medical {
  height: 4px;
  background: var(--medical-gray-light);
}

.card-footer-medical.bg-blue {
  background: linear-gradient(90deg, var(--medical-blue) 0%, var(--medical-blue-dark) 100%);
}

.card-footer-medical.bg-green {
  background: linear-gradient(90deg, var(--medical-green) 0%, var(--medical-green-dark) 100%);
}

.card-footer-medical.bg-warning {
  background: linear-gradient(90deg, var(--medical-warning) 0%, #E65100 100%);
}

.card-footer-medical.bg-info {
  background: linear-gradient(90deg, #0288D1 0%, #01579B 100%);
}

.text-medical-blue { color: var(--medical-blue); }
.text-medical-green { color: var(--medical-green); }
.text-medical-warning { color: var(--medical-warning); }
.text-medical-info { color: #0288D1; }

/* ========================================
   CARD HEADER CON GRADIENTE
   ======================================== */
.card-header-medical {
  background: linear-gradient(135deg, var(--medical-blue) 0%, var(--medical-blue-dark) 100%);
  border: none;
  padding: 1.25rem;
  border-radius: 12px 12px 0 0;
}

/* ========================================
   TABLA MÉDICA
   ======================================== */
.table-medical {
  margin-bottom: 0;
}

.table-medical thead {
  background: linear-gradient(135deg, var(--medical-blue) 0%, var(--medical-blue-dark) 100%);
  color: white;
}

.table-medical thead th {
  border: none;
  font-weight: 600;
  padding: 12px;
  text-align: center;
  vertical-align: middle;
  font-size: 0.9rem;
}

.table-medical tbody tr {
  transition: all 0.2s ease;
}

.table-medical tbody tr:hover {
  background-color: var(--medical-blue-light);
  transform: scale(1.01);
}

.table-medical tbody td {
  vertical-align: middle;
  padding: 12px;
  border-color: #dee2e6;
}

/* ========================================
   MODALES MÉDICOS
   ======================================== */
.modal-medical {
  border-radius: 15px;
  overflow: hidden;
}

.modal-header-medical {
  background: linear-gradient(135deg, var(--medical-blue) 0%, var(--medical-blue-dark) 100%);
  border: none;
  padding: 1.25rem;
}

.modal-header-medical-green {
  background: linear-gradient(135deg, var(--medical-green) 0%, var(--medical-green-dark) 100%);
  border: none;
  padding: 1.25rem;
}

.bg-medical-light {
  background-color: #FAFAFA;
}

/* ========================================
   SECCIONES DENTRO DE MODALES
   ======================================== */
.section-medical {
  background: white;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.section-header-medical {
  background: linear-gradient(135deg, var(--medical-blue-light) 0%, #BBDEFB 100%);
  color: var(--medical-blue-dark);
  padding: 12px 20px;
  font-weight: 600;
  font-size: 1rem;
  border-left: 4px solid var(--medical-blue);
}

.section-body-medical {
  padding: 20px;
}

/* ========================================
   FORMULARIOS MÉDICOS
   ======================================== */
.label-medical {
  font-weight: 600;
  color: var(--medical-gray);
  font-size: 0.9rem;
  margin-bottom: 0.5rem;
}

.form-control-medical {
  border: 2px solid #E0E0E0;
  border-radius: 8px;
  padding: 10px 15px;
  transition: all 0.3s ease;
  font-size: 0.95rem;
}

.form-control-medical:focus {
  border-color: var(--medical-blue);
  box-shadow: 0 0 0 0.2rem rgba(21, 101, 192, 0.15);
  outline: none;
}

.form-control-medical:read-only {
  background-color: #F5F5F5;
  cursor: pointer;
}

.input-group-medical .input-group-text-medical {
  background: var(--medical-blue);
  color: white;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
}

.input-group-medical .input-group-text-medical:hover {
  background: var(--medical-blue-dark);
}

/* ========================================
   BOTONES MÉDICOS
   ======================================== */
.btn-medical-primary {
  background: linear-gradient(135deg, var(--medical-blue) 0%, var(--medical-blue-dark) 100%);
  border: none;
  color: white;
  padding: 10px 25px;
  border-radius: 8px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(21, 101, 192, 0.3);
}

.btn-medical-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(21, 101, 192, 0.4);
  color: white;
}

.btn-medical-success {
  background: linear-gradient(135deg, var(--medical-green) 0%, var(--medical-green-dark) 100%);
  border: none;
  color: white;
  padding: 10px 25px;
  border-radius: 8px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);
}

.btn-medical-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4);
  color: white;
}

.btn-medical-warning {
  background: linear-gradient(135deg, var(--medical-warning) 0%, #E65100 100%);
  border: none;
  color: white;
  padding: 10px 25px;
  border-radius: 8px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(245, 124, 0, 0.3);
}

.btn-medical-warning:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(245, 124, 0, 0.4);
  color: white;
}

.btn-medical-secondary {
  background: var(--medical-gray);
  border: none;
  color: white;
  padding: 10px 25px;
  border-radius: 8px;
  font-weight: 600;
  transition: all 0.3s ease;
}

.btn-medical-secondary:hover {
  background: #37474F;
  transform: translateY(-2px);
  color: white;
}

.btn-medical-white {
  background: white;
  border: 2px solid white;
  color: var(--medical-blue);
  padding: 8px 20px;
  border-radius: 8px;
  font-weight: 600;
  transition: all 0.3s ease;
}

.btn-medical-white:hover {
  background: var(--medical-blue-light);
  border-color: var(--medical-blue-light);
  transform: translateY(-2px);
}

/* ========================================
   BADGES DE ESTADO
   ======================================== */
.badge-medical {
  padding: 6px 12px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.85rem;
}

.badge-medical-programada {
  background-color: var(--medical-blue-light);
  color: var(--medical-blue-dark);
}

.badge-medical-proceso {
  background-color: var(--medical-warning-light);
  color: var(--medical-warning);
}

.badge-medical-finalizada {
  background-color: var(--medical-green-light);
  color: var(--medical-green-dark);
}

.badge-medical-cancelada {
  background-color: #FFEBEE;
  color: #C62828;
}

/* ========================================
   ALERTAS MÉDICAS
   ======================================== */
.alert-medical-info {
  background: linear-gradient(135deg, var(--medical-blue-light) 0%, #E1F5FE 100%);
  border-left: 4px solid var(--medical-blue);
  color: var(--medical-blue-dark);
  padding: 15px;
  border-radius: 8px;
  font-size: 0.95rem;
}

/* ========================================
   HR MÉDICO
   ======================================== */
.hr-medical {
  border: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent 0%, var(--medical-blue) 50%, transparent 100%);
  margin: 2rem 0;
}

/* ========================================
   RESPONSIVO
   ======================================== */
@media (max-width: 768px) {
  .card-header-medical {
    flex-direction: column;
    gap: 1rem;
  }
  
  .icon-medical {
    width: 50px;
    height: 50px;
    font-size: 20px;
  }
  
  .btn-medical-white,
  .btn-medical-primary,
  .btn-medical-success,
  .btn-medical-warning {
    width: 100%;
    margin-bottom: 0.5rem;
  }
}
</style>

{% endblock %}


{% block js %}
<script>
// ============================================
// VARIABLES GLOBALES
// ============================================

let consultaActualId = null;
let detalleEditandoId = null;

// ============================================
// FUNCIONES AUXILIARES
// ============================================

/**
 * Formatea fecha YYYY-MM-DD a DD/MM/YYYY
 */
function formatDateForInput(fecha) {
  if (!fecha) return '';
  const d = new Date(fecha);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${year}-${month}-${day}`;
}

function formatDateForDisplay(fecha) {
  if (!fecha) return '';
  const d = new Date(fecha);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${day}/${month}/${year}`;
}

// ============================================
// ACTUALIZAR ESTADÍSTICAS
// ============================================
function actualizarEstadisticas() {
  fetch('/api/v1/consultas')
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        const consultas = d.data;
        const hoy = new Date().toISOString().split('T')[0];
        
        // Consultas de hoy
        const consultasHoy = consultas.filter(c => c.fecha_cita === hoy).length;
        $('#consultasHoy').text(consultasHoy);
        
        // En seguimiento (programadas + en proceso)
        const enSeguimiento = consultas.filter(c => 
          c.estado === 'programada' || c.estado === 'en_proceso'
        ).length;
        $('#consultasEnSeguimiento').text(enSeguimiento);
        
        // Finalizadas
        const finalizadas = consultas.filter(c => c.estado === 'finalizada').length;
        $('#consultasFinalizadas').text(finalizadas);
        
        // Total
        $('#totalConsultas').text(consultas.length);
      }
    })
    .catch(err => console.error('Error al actualizar estadísticas:', err));
}

// ============================================
// DATATABLE: CONSULTAS PRINCIPALES
// ============================================
function initDatatableConsultas() {
  if ($.fn.DataTable.isDataTable('#tblConsultas')) {
    $('#tblConsultas').DataTable().destroy();
  }

  $('#tblConsultas').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { 
      url: '/api/v1/consultas',
      dataSrc: 'data'
    },
    columns: [
      { 
        data: 'fecha_cita',
        render: d => formatDateForDisplay(d)
      },
      { data: 'hora_cita' },
      { data: 'nombre_paciente' },
      { data: 'nombre_medico' },
      { data: 'nombre_consultorio' },
      { 
        data: 'duracion_minutos',
        render: d => d || 'N/A'
      },
      { 
        data: 'estado',
        render: function(d) {
          let color = '#155724', bg = '#d4edda';
          if (d === 'cancelada') { color = '#721c24'; bg = '#f8d7da'; }
          if (d === 'en_proceso') { color = '#856404'; bg = '#fff3cd'; }
          if (d === 'programada') { color = '#004085'; bg = '#cce5ff'; }
          return `<span style="color:${color}; background-color:${bg}; padding:2px 6px; border-radius:4px;">${d}</span>`;
        }
      },
      { 
        data: null,
        render: row => `
          <button class="btn btn-success btn-sm" name="btn_detalles" 
                  data-id="${row.id_consulta_cab}" title="Ver Detalles">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-info btn-sm" name="btn_editar" 
                  data-id="${row.id_consulta_cab}" title="Editar">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-danger btn-sm" name="btn_eliminar" 
                  data-id="${row.id_consulta_cab}" title="Eliminar">
            <i class="fas fa-trash-alt"></i>
          </button>
        `
      }
    ],
    order: [[0, 'desc']],
    drawCallback: function() {
      actualizarEstadisticas();
    }
  });
}

// ============================================
// DATATABLE: PACIENTES
// ============================================
function initDatatablePaciente() {
  if ($.fn.DataTable.isDataTable('#tblPaciente')) {
    $('#tblPaciente').DataTable().destroy();
  }

  $('#tblPaciente').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { 
      url: '/api/v1/pacientes',
      dataSrc: 'data'
    },
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: 'cedula_entidad' },
      { 
        data: null,
        render: row => `
          <button class="btn btn-primary btn-sm" name="btn_seleccionar_paciente"
                  data-id="${row.id_paciente}"
                  data-nombre="${row.nombre}"
                  data-apellido="${row.apellido}">
            Seleccionar
          </button>
        `
      }
    ]
  });

  // Evento seleccionar paciente
  $('#tblPaciente').on('click', 'button[name="btn_seleccionar_paciente"]', function() {
    const btn = $(this);
    $('#id_paciente').val(btn.data('id'));
    $('#txtPaciente').val(`${btn.data('nombre')} ${btn.data('apellido')}`);
    $('#modalBuscarPaciente').modal('hide');
  });
}

// ============================================
// DATATABLE: MÉDICOS
// ============================================
function initDatatableMedico() {
  if ($.fn.DataTable.isDataTable('#tblMedico')) {
    $('#tblMedico').DataTable().destroy();
  }

  $('#tblMedico').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { 
      url: '/api/v1/medico',
      dataSrc: 'data'
    },
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: 'especialidades' },
      { 
        data: null,
        render: row => `
          <button class="btn btn-primary btn-sm" name="btn_seleccionar_medico"
                  data-id="${row.id_medico}"
                  data-nombre="${row.nombre}"
                  data-apellido="${row.apellido}"
                  data-especialidad="${row.especialidades || 'N/A'}"> 
            Seleccionar
          </button>
        `
      }
    ]
  });

  // Evento seleccionar médico
  $('#tblMedico').on('click', 'button[name="btn_seleccionar_medico"]', function() {
    const btn = $(this);
    $('#id_medico').val(btn.data('id'));
    $('#txtMedico').val(`${btn.data('nombre')} ${btn.data('apellido')} - ${btn.data('especialidad')}`);
    $('#modalBuscarMedico').modal('hide');
  });
}

// ============================================
// DATATABLE: CONSULTORIOS
// ============================================
function initDatatableConsultorio() {
  if ($.fn.DataTable.isDataTable('#tblConsultorio')) {
    $('#tblConsultorio').DataTable().destroy();
  }

  $('#tblConsultorio').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { 
      url: '/api/v1/consultorios',
      dataSrc: 'data'
    },
    columns: [
      { data: 'nombre_consultorio' },
      { 
        data: null,
        render: row => `
          <button class="btn btn-primary btn-sm" name="btn_seleccionar_consultorio"
                  data-id="${row.codigo}"
                  data-nombre="${row.nombre_consultorio}">
            Seleccionar
          </button>
        `
      }
    ]
  });

  // Evento seleccionar consultorio
  $('#tblConsultorio').on('click', 'button[name="btn_seleccionar_consultorio"]', function() {
    const btn = $(this);
    $('#id_consultorio').val(btn.data('id'));
    $('#txtConsultorio').val(btn.data('nombre'));
    $('#modalBuscarConsultorio').modal('hide');
  });
}

// ============================================
// DATATABLE: FUNCIONARIOS
// ============================================
function initDatatableFuncionario() {
  if ($.fn.DataTable.isDataTable('#tblFuncionario')) {
    $('#tblFuncionario').DataTable().destroy();
  }

  $('#tblFuncionario').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { 
      url: '/api/v1/funcionarios',
      dataSrc: 'data'
    },
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: 'cargo' },
      { 
        data: null,
        render: row => `
          <button class="btn btn-primary btn-sm" name="btn_seleccionar_funcionario"
                  data-id="${row.id_funcionario}"
                  data-nombre="${row.nombre}"
                  data-apellido="${row.apellido}">
            Seleccionar
          </button>
        `
      }
    ]
  });

  // Evento seleccionar funcionario
  $('#tblFuncionario').on('click', 'button[name="btn_seleccionar_funcionario"]', function() {
    const btn = $(this);
    $('#id_funcionario').val(btn.data('id'));
    $('#txtFuncionario').val(`${btn.data('nombre')} ${btn.data('apellido')}`);
    $('#modalBuscarFuncionario').modal('hide');
  });
}

// ============================================
// DATATABLE: SÍNTOMAS
// ============================================
function initDatatableSintoma() {
  if ($.fn.DataTable.isDataTable('#tblSintoma')) {
    $('#tblSintoma').DataTable().destroy();
  }

  $('#tblSintoma').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { 
      url: '/api/v1/sintomas',
      dataSrc: 'data'
    },
    columns: [
      { data: 'descripcion_sintoma' },
      { 
        data: null,
        render: row => `
          <button class="btn btn-primary btn-sm" name="btn_seleccionar_sintoma"
                  data-id="${row.id_sintoma}"
                  data-descripcion="${row.descripcion_sintoma}">
            Seleccionar
          </button>
        `
      }
    ]
  });

  // Evento seleccionar síntoma
  $('#tblSintoma').on('click', 'button[name="btn_seleccionar_sintoma"]', function() {
    const btn = $(this);
    $('#id_sintoma').val(btn.data('id'));
    $('#txtSintoma').val(btn.data('descripcion'));
    $('#modalBuscarSintoma').modal('hide');
  });
}

// ============================================
// ABRIR MODALES DE SELECCIÓN
// ============================================
$('#txtPaciente').click(() => $('#modalBuscarPaciente').modal('show'));
$('#txtMedico').click(() => $('#modalBuscarMedico').modal('show'));
$('#txtConsultorio').click(() => $('#modalBuscarConsultorio').modal('show'));
$('#txtFuncionario').click(() => $('#modalBuscarFuncionario').modal('show'));
$('#txtSintoma').click(() => $('#modalBuscarSintoma').modal('show'));

// ============================================
// LIMPIAR FORMULARIO
// ============================================
function limpiarModal() {
  $('#txtIdConsulta').val('');
  $('#id_paciente').val('');
  $('#txtPaciente').val('');
  $('#id_medico').val('');
  $('#txtMedico').val('');
  $('#id_consultorio').val('');
  $('#txtConsultorio').val('');
  $('#id_funcionario').val('');
  $('#txtFuncionario').val('');
  $('#fecha_cita').val('');
  $('#hora_cita').val('');
  $('#duracion_minutos').val('');
  $('#estado').val('programada');
  $('.text-danger.small').hide();
}

// ============================================
// BOTÓN: AGREGAR NUEVA CONSULTA
// ============================================
$('#btnAgregar').on('click', function() {
  limpiarModal();
  $('#modalTitle').text('Nueva Consulta');
  $('#modalFormulario').modal('show');
});

// ============================================
// GUARDAR CONSULTA (CON VALIDACIÓN DE FICHA)
// ============================================
$('#btnGuardar').on('click', function() {
  const idConsulta = $('#txtIdConsulta').val();
  
  // Preparar datos
  const payload = {
    id_paciente: parseInt($('#id_paciente').val()),
    id_medico: parseInt($('#id_medico').val()),
    id_consultorio: parseInt($('#id_consultorio').val()),
    id_funcionario: $('#id_funcionario').val() ? parseInt($('#id_funcionario').val()) : null,
    fecha_cita: $('#fecha_cita').val(),
    hora_cita: $('#hora_cita').val(),
    duracion_minutos: $('#duracion_minutos').val() ? parseInt($('#duracion_minutos').val()) : null,
    estado: $('#estado').val()
  };

  // Validaciones
  let valido = true;
  $('.text-danger.small').hide();
  
  if (!payload.id_paciente) { $('#error_txtPaciente').show(); valido = false; }
  if (!payload.id_medico) { $('#error_txtMedico').show(); valido = false; }
  if (!payload.id_consultorio) { $('#error_txtConsultorio').show(); valido = false; }
  if (!payload.fecha_cita) { $('#error_fecha_cita').show(); valido = false; }
  if (!payload.hora_cita) { $('#error_hora_cita').show(); valido = false; }

  if (!valido) {
    Swal.fire('Campos incompletos', 'Complete todos los campos obligatorios', 'warning');
    return;
  }

  // Determinar URL y método
  const url = idConsulta ? `/api/v1/consultas/${idConsulta}` : '/api/v1/consultas';
  const method = idConsulta ? 'PUT' : 'POST';

  // Enviar petición
  fetch(url, {
    method: method,
    headers: { 
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      const consultaId = d.data.id_consulta_cab;
      
      $('#modalFormulario').modal('hide');
      $('#tblConsultas').DataTable().ajax.reload();
      
      // 🆕 SI ES NUEVA CONSULTA, SUGERIR CREAR FICHA
      if (!idConsulta) {
        Swal.fire({
          title: '¡Consulta guardada!',
          html: '¿Deseas crear la Ficha Médica ahora?<br><small class="text-muted">Es obligatorio para finalizar la consulta</small>',
          icon: 'success',
          showCancelButton: true,
          confirmButtonText: 'Sí, crear ahora',
          cancelButtonText: 'Después',
          confirmButtonColor: '#28a745',
          cancelButtonColor: '#6c757d'
        }).then((result) => {
          if (result.isConfirmed) {
            // Cargar información de la consulta
            fetch(`/api/v1/consultas/${consultaId}`)
              .then(r => r.json())
              .then(d => {
                if (d.success) {
                  const c = d.data;
                  $('#infoConsulta').html(`
                    <strong>Paciente:</strong> ${c.nombre_paciente}<br>
                    <strong>Médico:</strong> ${c.nombre_medico}<br>
                    <strong>Fecha:</strong> ${formatDateForDisplay(c.fecha_cita)} - ${c.hora_cita}<br>
                    <strong>Consultorio:</strong> ${c.nombre_consultorio}<br>
                    <strong>Estado:</strong> ${c.estado}
                  `);
                }
              });
            
            // Configurar ID de consulta y abrir modal de ficha médica
            consultaActualId = consultaId;
            $('#idConsultaFicha').val(consultaId);
            $('#idFichaMedicaExistente').val('');
            
            // Limpiar campos de ficha médica
            $('#presion_arterial, #temperatura, #frecuencia_cardiaca, #frecuencia_respiratoria, #peso, #talla, #imc, #examen_fisico_general, #examen_bucal, #observaciones_medico').val('');
            
            // Abrir modal de ficha médica
            $('#modalFichaMedica').modal('show');
          }
        });
      } else {
        // Si es edición, solo mostrar mensaje de éxito
        Swal.fire('Éxito', 'Consulta actualizada correctamente', 'success');
      }
    } else {
      Swal.fire('Error', d.error || 'No se pudo guardar', 'error');
    }
  })
  .catch(err => {
    console.error('Error:', err);
    Swal.fire('Error', 'No se pudo guardar la consulta', 'error');
  });
});


// ============================================
// EDITAR CONSULTA
// ============================================
$('#tblConsultas').on('click', 'button[name="btn_editar"]', function() {
  const id = $(this).data('id');
  
  fetch(`/api/v1/consultas/${id}`)
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        const c = d.data;
        $('#txtIdConsulta').val(c.id_consulta_cab);
        $('#id_paciente').val(c.id_paciente);
        $('#txtPaciente').val(c.nombre_paciente);
        $('#id_medico').val(c.id_medico);
        $('#txtMedico').val(c.nombre_medico);
        $('#id_consultorio').val(c.id_consultorio);
        $('#txtConsultorio').val(c.nombre_consultorio);
        $('#id_funcionario').val(c.id_funcionario || '');
        $('#fecha_cita').val(c.fecha_cita);
        $('#hora_cita').val(c.hora_cita);
        $('#duracion_minutos').val(c.duracion_minutos);
        $('#estado').val(c.estado);

        $('#modalTitle').text('Editar Consulta');
        $('#modalFormulario').modal('show');
      }
    })
    .catch(err => {
      console.error('Error:', err);
      Swal.fire('Error', 'No se pudo cargar la consulta', 'error');
    });
});

// ============================================
// ELIMINAR CONSULTA
// ============================================
$('#tblConsultas').on('click', 'button[name="btn_eliminar"]', function() {
  const id = $(this).data('id');
  
  Swal.fire({
    title: '¿Eliminar consulta?',
    text: 'Esta acción eliminará la consulta y todos sus detalles',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Sí, eliminar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/api/v1/consultas/${id}`, {
        method: 'DELETE'
      })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          $('#tblConsultas').DataTable().ajax.reload();
          Swal.fire('Eliminado', 'Consulta eliminada correctamente', 'success');
        } else {
          Swal.fire('Error', d.error, 'error');
        }
      })
      .catch(err => {
        console.error('Error:', err);
        Swal.fire('Error', 'No se pudo eliminar la consulta', 'error');
      });
    }
  });
});
// ============================================
// VER DETALLES DE CONSULTA
// ============================================
$('#tblConsultas').on('click', 'button[name="btn_detalles"]', function() {
  const id = $(this).data('id');
  consultaActualId = id;

  // Cargar información de la consulta
  fetch(`/api/v1/consultas/${id}`)
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        const c = d.data;
        $('#infoConsulta').html(`
          <strong>Paciente:</strong> ${c.nombre_paciente}<br>
          <strong>Médico:</strong> ${c.nombre_medico}<br>
          <strong>Fecha:</strong> ${formatDateForDisplay(c.fecha_cita)} - ${c.hora_cita}<br>
          <strong>Consultorio:</strong> ${c.nombre_consultorio}<br>
          <strong>Estado:</strong> ${c.estado}
        `);
      }
    })
    .catch(err => {
      console.error('Error:', err);
      $('#infoConsulta').html('<span class="text-danger">Error al cargar información</span>');
    });

  // Cargar detalles clínicos
  cargarDetallesConsulta(id);
  
  // Limpiar formulario de detalle
  limpiarModalDetalle();
  
  $('#modalDetalles').modal('show');
});

// ============================================
// CARGAR DETALLES CLÍNICOS
// ============================================
function cargarDetallesConsulta(idConsulta) {
  fetch(`/api/v1/consultas-detalle/consulta/${idConsulta}`)
    .then(r => r.json())
    .then(d => {
      const tbody = $('#tblDetalles tbody');
      tbody.empty();

      if (d.success && d.data.length > 0) {
        d.data.forEach(det => {
          tbody.append(`
            <tr>
              <td>${det.descripcion_sintoma || 'N/A'}</td>
              <td>${det.pieza_dental || '-'}</td>
              <td>${det.diagnostico || '-'}</td>
              <td>${det.tratamiento || '-'}</td>
              <td>${det.procedimiento || '-'}</td>
              <td>
                <button class="btn btn-info btn-sm" name="btn_editar_detalle" 
                        data-id="${det.id_consulta_detalle}"
                        data-id_sintoma="${det.id_sintoma}"
                        data-descripcion_sintoma="${det.descripcion_sintoma || ''}"
                        data-pieza_dental="${det.pieza_dental || ''}"
                        data-diagnostico="${det.diagnostico || ''}"
                        data-tratamiento="${det.tratamiento || ''}"
                        data-procedimiento="${det.procedimiento || ''}"
                        title="Editar">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-danger btn-sm" name="btn_eliminar_detalle" 
                        data-id="${det.id_consulta_detalle}"
                        title="Eliminar">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </td>
            </tr>
          `);
        });
      } else {
        tbody.append(`
          <tr>
            <td colspan="6" class="text-center text-muted">No hay detalles registrados</td>
          </tr>
        `);
      }
    })
    .catch(err => {
      console.error('Error al cargar detalles:', err);
      $('#tblDetalles tbody').html(`
        <tr>
          <td colspan="6" class="text-center text-danger">Error al cargar los detalles</td>
        </tr>
      `);
    });
}

// ============================================
// LIMPIAR FORMULARIO DETALLE
// ============================================
function limpiarModalDetalle() {
  $('#id_sintoma').val('');
  $('#txtSintoma').val('');
  $('#pieza_dental').val('');
  $('#diagnostico').val('');
  $('#tratamiento').val('');
  $('#procedimiento').val('');
  $('.text-danger.small').hide();
  detalleEditandoId = null;
  $('#btnAgregarDetalle').html('<i class="fas fa-plus"></i> Agregar Detalle');
}

// ============================================
// AGREGAR DETALLE CLÍNICO
// ============================================
$('#btnAgregarDetalle').on('click', function() {
  const payload = {
    id_consulta_cab: consultaActualId,
    id_sintoma: parseInt($('#id_sintoma').val()),
    pieza_dental: $('#pieza_dental').val() || null,
    diagnostico: $('#diagnostico').val(),
    tratamiento: $('#tratamiento').val(),
    procedimiento: $('#procedimiento').val() || null
  };

  // Validaciones
  let valido = true;
  $('.text-danger.small').hide();
  
  if (!payload.id_sintoma) { $('#error_txtSintoma').show(); valido = false; }
  if (!payload.diagnostico) { $('#error_diagnostico').show(); valido = false; }
  if (!payload.tratamiento) { $('#error_tratamiento').show(); valido = false; }

  if (!valido) {
    Swal.fire('Campos incompletos', 'Complete todos los campos obligatorios', 'warning');
    return;
  }

  // Determinar URL y método
  const url = detalleEditandoId 
    ? `/api/v1/consultas-detalle/${detalleEditandoId}` 
    : '/api/v1/consultas-detalle';
  const method = detalleEditandoId ? 'PUT' : 'POST';
  const mensajeExito = detalleEditandoId ? 'actualizado' : 'agregado';

  // Enviar petición
  fetch(url, {
    method: method,
    headers: { 
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      limpiarModalDetalle();
      cargarDetallesConsulta(consultaActualId);
      Swal.fire('Éxito', `Detalle ${mensajeExito} correctamente`, 'success');
    } else {
      Swal.fire('Error', d.error || `No se pudo ${mensajeExito}`, 'error');
    }
  })
  .catch(err => {
    console.error('Error:', err);
    Swal.fire('Error', 'No se pudo guardar el detalle', 'error');
  });
});

// ============================================
// EDITAR DETALLE CLÍNICO
// ============================================
$('#tblDetalles').on('click', 'button[name="btn_editar_detalle"]', function() {
  const btn = $(this);
  detalleEditandoId = btn.data('id');
  
  $('#id_sintoma').val(btn.data('id_sintoma'));
  $('#txtSintoma').val(btn.data('descripcion_sintoma'));
  $('#pieza_dental').val(btn.data('pieza_dental'));
  $('#diagnostico').val(btn.data('diagnostico'));
  $('#tratamiento').val(btn.data('tratamiento'));
  $('#procedimiento').val(btn.data('procedimiento'));
  
  $('#btnAgregarDetalle').html('<i class="fas fa-save"></i> Actualizar Detalle');
  
  // Scroll al formulario
  $('html, body').animate({
    scrollTop: $('#txtSintoma').offset().top - 100
  }, 500);
});

// ============================================
// ELIMINAR DETALLE CLÍNICO
// ============================================
$('#tblDetalles').on('click', 'button[name="btn_eliminar_detalle"]', function() {
  const idDetalle = $(this).data('id');
  
  Swal.fire({
    title: '¿Eliminar detalle?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Sí, eliminar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/api/v1/consultas-detalle/${idDetalle}`, {
        method: 'DELETE'
      })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          cargarDetallesConsulta(consultaActualId);
          Swal.fire('Eliminado', 'Detalle eliminado correctamente', 'success');
        } else {
          Swal.fire('Error', d.error, 'error');
        }
      })
      .catch(err => {
        console.error('Error:', err);
        Swal.fire('Error', 'No se pudo eliminar el detalle', 'error');
      });
    }
  });
});

// ============================================
// BOTÓN: VER/EDITAR FICHA MÉDICA
// ============================================
$('#btnVerEditarFichaMedica').on('click', function() {
  const idConsulta = consultaActualId;
  
  if (!idConsulta) {
    Swal.fire('Error', 'No se ha seleccionado una consulta', 'error');
    return;
  }
  
  // Verificar si la consulta tiene ficha médica
  fetch(`/api/v1/ficha-medica/consulta/${idConsulta}`)
    .then(r => r.json())
    .then(d => {
      if (d.success && d.data) {
        // ✅ LA CONSULTA TIENE FICHA - Abrir para ver/editar
        const ficha = d.data;
        $('#idConsultaFicha').val(idConsulta);
        $('#idFichaMedicaExistente').val(ficha.id_ficha_medica);
        
        // 🆕 Cambiar título y color del modal
        $('#modalFichaMedica .modal-title').html('<i class="fas fa-edit"></i> Editar Ficha Médica');
        $('#modalFichaMedica .modal-header').removeClass('bg-success').addClass('bg-warning text-dark');
        
        // Cargar datos existentes
        $('#presion_arterial').val(ficha.presion_arterial || '');
        $('#temperatura').val(ficha.temperatura || '');
        $('#frecuencia_cardiaca').val(ficha.frecuencia_cardiaca || '');
        $('#frecuencia_respiratoria').val(ficha.frecuencia_respiratoria || '');
        $('#peso').val(ficha.peso || '');
        $('#talla').val(ficha.talla || '');
        $('#imc').val(ficha.imc || '');
        $('#examen_fisico_general').val(ficha.examen_fisico_general || '');
        $('#examen_bucal').val(ficha.examen_bucal || '');
        $('#observaciones_medico').val(ficha.observaciones_medico || '');
        
        // Abrir modal
        $('#modalFichaMedica').modal('show');
        
      } else {
        // ❌ LA CONSULTA NO TIENE FICHA - Preguntar si desea crear
        Swal.fire({
          title: 'Sin Ficha Médica',
          html: 'Esta consulta no tiene ficha médica registrada.<br>¿Deseas crearla ahora?',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Sí, crear ahora',
          cancelButtonText: 'Cancelar',
          confirmButtonColor: '#28a745',
          cancelButtonColor: '#6c757d'
        }).then((result) => {
          if (result.isConfirmed) {
            // Preparar modal para crear nueva ficha
            $('#idConsultaFicha').val(idConsulta);
            $('#idFichaMedicaExistente').val('');
            
            // 🆕 Cambiar título y color del modal
            $('#modalFichaMedica .modal-title').html('<i class="fas fa-plus-circle"></i> Crear Ficha Médica');
            $('#modalFichaMedica .modal-header').removeClass('bg-warning text-dark').addClass('bg-success text-white');
            
            // Limpiar todos los campos
            $('#presion_arterial, #temperatura, #frecuencia_cardiaca, #frecuencia_respiratoria, #peso, #talla, #imc, #examen_fisico_general, #examen_bucal, #observaciones_medico').val('');
            
            // Abrir modal
            $('#modalFichaMedica').modal('show');
          }
        });
      }
    })
    .catch(err => {
      console.error('Error al verificar ficha:', err);
      Swal.fire('Error', 'No se pudo verificar si la consulta tiene ficha médica', 'error');
    });
});

// ============================================
// CALCULAR IMC AUTOMÁTICAMENTE
// ============================================
$('#peso, #talla').on('input', function() {
  const peso = parseFloat($('#peso').val());
  const talla = parseFloat($('#talla').val()) / 100; // Convertir cm a m
  
  if (peso && talla) {
    const imc = (peso / (talla * talla)).toFixed(2);
    $('#imc').val(imc);
  }
});

// ============================================
// GUARDAR FICHA MÉDICA
// ============================================
$('#btnGuardarFichaMedica').on('click', function() {
  const idFichaExistente = $('#idFichaMedicaExistente').val();
  
  const payload = {
    id_consulta_cab: consultaActualId,
    presion_arterial: $('#presion_arterial').val() || null,
    temperatura: $('#temperatura').val() ? parseFloat($('#temperatura').val()) : null,
    frecuencia_cardiaca: $('#frecuencia_cardiaca').val() ? parseInt($('#frecuencia_cardiaca').val()) : null,
    frecuencia_respiratoria: $('#frecuencia_respiratoria').val() ? parseInt($('#frecuencia_respiratoria').val()) : null,
    peso: $('#peso').val() ? parseFloat($('#peso').val()) : null,
    talla: $('#talla').val() ? parseFloat($('#talla').val()) : null,
    imc: $('#imc').val() ? parseFloat($('#imc').val()) : null,
    examen_fisico_general: $('#examen_fisico_general').val() || null,
    examen_bucal: $('#examen_bucal').val() || null,
    observaciones_medico: $('#observaciones_medico').val() || null
  };

  // Determinar URL y método
  const url = idFichaExistente 
    ? `/api/v1/ficha-medica/${idFichaExistente}` 
    : '/api/v1/ficha-medica';
  const method = idFichaExistente ? 'PUT' : 'POST';
  const mensajeExito = idFichaExistente ? 'actualizada' : 'creada';

  // Enviar petición
  fetch(url, {
    method: method,
    headers: { 
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      $('#modalFichaMedica').modal('hide');
      Swal.fire('Éxito', `Ficha médica ${mensajeExito} correctamente`, 'success');
    } else {
      Swal.fire('Error', d.error || 'No se pudo guardar', 'error');
    }
  })
  .catch(err => {
    console.error('Error:', err);
    Swal.fire('Error', 'No se pudo guardar la ficha médica', 'error');
  });
});

// ============================================
// BOTÓN: GESTIONAR DIAGNÓSTICOS
// ============================================
$('#btnGestionarDiagnosticos').on('click', function() {
  Swal.fire({
    title: 'Gestionar Diagnósticos',
    html: `
      <p>Esta funcionalidad abrirá el módulo completo de <strong>Registrar Diagnósticos</strong>.</p>
      <p class="text-muted">Se implementará en el siguiente paso.</p>
    `,
    icon: 'info',
    confirmButtonText: 'Entendido'
  });
  
  // TODO: Implementar navegación al módulo de Registrar Diagnósticos
  // window.location.href = '/referenciales/diagnostico/diagnostico-index?consulta=' + consultaActualId;
});

// ============================================
// BOTÓN: REGISTRAR TRATAMIENTOS
// ============================================
$('#btnRegistrarTratamientos').on('click', function() {
  Swal.fire({
    title: 'Registrar Tratamientos',
    html: `
      <p>Esta funcionalidad abrirá el módulo completo de <strong>Registrar Tratamientos</strong>.</p>
      <p class="text-muted">Se implementará en el siguiente paso.</p>
    `,
    icon: 'info',
    confirmButtonText: 'Entendido'
  });
  
  // TODO: Implementar navegación al módulo de Registrar Tratamientos
  // window.location.href = '/referenciales/tratamiento/tratamiento-index?consulta=' + consultaActualId;
});

// ============================================
// INICIALIZACIÓN AL CARGAR LA PÁGINA
// ============================================
$(document).ready(function() {
  // Inicializar todas las tablas
  initDatatableConsultas();
  initDatatablePaciente();
  initDatatableMedico();
  initDatatableConsultorio();
  initDatatableFuncionario();
  initDatatableSintoma();
  
  // Actualizar estadísticas
  actualizarEstadisticas();
  
  console.log('✅ Módulo de Registrar Consulta inicializado correctamente');
});
</script>
{% endblock %}