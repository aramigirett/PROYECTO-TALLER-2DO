{% extends 'base.html' %}

{% block titulo %}
Médicos
{% endblock %}

{% block contenido %}
<div class="container mt-10">
  <h3>Listar Médicos</h3>

  <!-- Tarjeta -->
  <div class="card">
    <div class="card-header">
      <button type="button" class="btn btn-outline-primary" id="btnAgregar">Agregar</button>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped" id="tbl">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Cédula</th>
              <th>Fecha Nacimiento</th>
              <th>Ciudad</th>
              <th>Dirección</th>
              <th>Teléfono</th>
              <th>Correo</th>
              <th>Especialidad</th>
              <th>N° Matricula</th>
              <th>Fecha Registro</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- /Tarjeta -->

  <!-- El formulario -->
  <div class="modal" id="modalFormulario">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title" id="modalTitle"></h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <!-- Modal body -->
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <!-- Inputs hidden CORREGIDOS -->
          <input type="hidden" id="txtIdMedico">
          <input type="hidden" id="txtIdPaciente">
          <input type="hidden" id="id_ciudad">
          <input type="hidden" id="id_especialidad">
          
          <div class="container-fluid">
            <div class="row">
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="nombre">Nombre:</label>
                  <input type="text" class="form-control" placeholder="Ingrese el nombre" id="nombre">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="apellido">Apellido:</label>
                  <input type="text" class="form-control" placeholder="Ingrese el apellido" id="apellido">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="cedula">Cédula:</label>
                  <input type="text" class="form-control" placeholder="Ingrese la cédula" id="cedula">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="fecha_nacimiento">Fecha de nacimiento:</label>
                  <input type="date" class="form-control" id="fecha_nacimiento">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="direccion">Dirección:</label>
                  <input type="text" class="form-control" placeholder="Ingrese la direccion" id="direccion" autocomplete="off">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="telefono">Teléfono:</label>
                  <input type="text" class="form-control" placeholder="Ingrese el teléfono" id="telefono">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="correo">Correo:</label>
                  <input type="email" class="form-control" placeholder="Ingrese el correo" id="correo" autocomplete="off">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="txtCiudad">Ciudad:</label>
                  <input type="text" class="form-control" placeholder="Seleccione la ciudad" id="txtCiudad" readonly>
                </div>
              </div>
              <!-- Especialidad y otros campos DENTRO del modal-body -->
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="txtEspecialidad">Especialidad:</label>
                  <input type="text" class="form-control" placeholder="Seleccione la especialidad" id="txtEspecialidad" readonly>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="txtregistro">Numero Registro:</label>
                  <input type="text" class="form-control" placeholder="Ingrese el número de registro" id="txtregistro">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="fecha_registro">Fecha de Registro:</label>
                  <input type="date" class="form-control" id="fecha_registro">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Buscar Especialidad -->
  <div class="modal" id="modalBuscarEspecialidad">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modalEspecialidadTitle">Seleccionar Especialidad</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblEspecialidad">
              <thead>
                <tr>
                  <th>Especialidad</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Buscar Ciudad -->
  <div class="modal" id="modalBuscarCiudad">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modalCiudadTitle">Seleccionar Ciudad</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblCiudad">
              <thead>
                <tr>
                  <th>Ciudad</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block js %}
<script>

  const initDatatable = () => {
    if ($.fn.dataTable.isDataTable('#tbl')) {
      $('#tbl').DataTable().destroy();
    }

    $('#tbl').DataTable({
      language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
      ajax: '/api/v1/medico',
      columns: [
        { data: 'nombre' },
        { data: 'apellido' },
        { data: 'cedula' },
        { data: 'fecha_nacimiento' },
        { data: 'ciudades' },
        { data: 'direccion' },
        { data: 'telefono' },
        { data: 'correo' },
        { data: 'especialidades' },
        { data: 'num_registro' },
        { data: 'fecha_registro' },
        {
          data: row => `
            <button type="button" name="btn_editar" class="btn btn-outline-primary" data-id_medico="${row.id_medico}">
              <i class="fas fa-edit"></i>
            </button>
            <button type="button" name="btn_eliminar" class="btn btn-outline-warning" data-id_medico="${row.id_medico}">
              <i class="fas fa-trash-alt"></i>
            </button>`
        }
      ]
    });
  };

  const initDatatablee = () => {
    if ($.fn.dataTable.isDataTable('#tblEspecialidad')) {
      $('#tblEspecialidad').DataTable().destroy();
    }

    $('#tblEspecialidad').DataTable({
      language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
      ajax: '/api/v1/especialidades',
      columns: [
        { data: 'nombre_especialidad' },
        { data: row => `<button type="button" name="btn_seleccionar_especialidad" class="btn btn-primary"
                        data-id="${row.id_especialidad}" data-especialidad="${row.nombre_especialidad}">Seleccionar</button>`}
      ]
    });

    $('#tblEspecialidad').on('click','button[name="btn_seleccionar_especialidad"]',function(){
      const id = $(this).data('id');
      const esp = $(this).data('especialidad');
      $('#txtEspecialidad').val(esp);
      $('#id_especialidad').val(id);
      $('#modalBuscarEspecialidad').modal('hide');
    });
  };

  const initDatatablec = () => {
    if ($.fn.dataTable.isDataTable('#tblCiudad')) {
      $('#tblCiudad').DataTable().destroy();
    }

    $('#tblCiudad').DataTable({
      language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
      ajax: '/api/v1/ciudades',
      columns: [
        { data: 'descripcion' },
        { data: function(row) {
          return `<button type="button" name="btn_seleccionar_ciudad" class="btn btn-primary" data-id="${row.id_ciudad}" data-ciudad="${row.descripcion}">Seleccionar</button>`;
        }}
      ]
    });

    $('#tblCiudad').on('click', 'button[name="btn_seleccionar_ciudad"]', function () {
      const idCiudad = $(this).data('id');
      const ciudad = $(this).data('ciudad');
      $('#txtCiudad').val(ciudad);
      $('#id_ciudad').val(idCiudad);
      $('#modalBuscarCiudad').modal('hide');
    });
  };

  const buscarCiudad = () => {
    $('#txtCiudad').on('click', function () {
      $('#modalCiudadTitle').text("Seleccionar Ciudad");
      $('#modalBuscarCiudad').modal();
    });
  };

  const buscarEspecialidad = () => {
    $('#txtEspecialidad').on('click', function(){
      $('#modalEspecialidadTitle').text("Seleccionar Especialidad");
      $('#modalBuscarEspecialidad').modal();
    });
  };

  const agregar = () => {
    $('#btnAgregar').on('click', function(){
      $('#modalTitle').text("Agregar Medico");
      $('#txtIdMedico').val("");
      $('#nombre').val("");
      $('#apellido').val("");
      $('#cedula').val("");
      $('#fecha_nacimiento').val("");
      $('#telefono').val("");
      $('#direccion').val("");
      $('#correo').val("");
      $('#txtCiudad').val("");
      $('#id_ciudad').val("");
      $('#txtEspecialidad').val("");
      $('#id_especialidad').val("");
      $('#txtregistro').val("");
      $('#fecha_registro').val("");
      $('#modalFormulario').modal();
    });
  };

  const guardar = () => {
    $('#btnGuardar').on('click', function() {
      const idMedico = $('#txtIdMedico').val();
      const datos = {
        nombre: $('#nombre').val(),
        apellido: $('#apellido').val(),
        cedula: $('#cedula').val(),
        fecha_nacimiento: $('#fecha_nacimiento').val(),
        fecha_registro: $('#fecha_registro').val(),
        telefono: $('#telefono').val(),
        direccion: $('#direccion').val(),
        correo: $('#correo').val(),
        id_ciudad: $('#id_ciudad').val(),
        id_especialidad: $('#id_especialidad').val(),
        num_registro: $('#txtregistro').val()
      };

      console.log('Datos a enviar:', datos); // Para debug

      const url = idMedico ? `/api/v1/medico/${idMedico}` : '/api/v1/medico';
      const method = idMedico ? 'PUT' : 'POST';

      fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json'},
        body: JSON.stringify(datos)
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.success) {
          $('#tbl').DataTable().ajax.reload();
          Swal.fire("Éxito", idMedico ? "Médico actualizado" : "Médico registrado", "success");
          $('#modalFormulario').modal('hide');
        } else {
          Swal.fire("Error", data.error, "error");
        }
      })
      .catch(err => {
        console.error('Error:', err);
        Swal.fire("Error", "Ocurrió un error al guardar", "error");
      });
    });
  };

  const editar = () => {
    $('#tbl').on('click', 'button[name="btn_editar"]', function() {
      const idMedico = $(this).data('id_medico');
      fetch(`/api/v1/medico/${idMedico}`)
        .then(resp => resp.json())
        .then(data => {
          console.log('Datos del médico:', data); // Para debug
          const m = data.data;
          $('#modalTitle').text("Editar Médico");
          $('#txtIdMedico').val(m.id_medico);
          $('#nombre').val(m.nombre);
          $('#apellido').val(m.apellido);
          $('#cedula').val(m.cedula);
          $('#fecha_nacimiento').val(m.fecha_nacimiento);
          $('#fecha_registro').val(m.fecha_registro);
          $('#telefono').val(m.telefono);
          $('#direccion').val(m.direccion);
          $('#correo').val(m.correo);
          $('#id_ciudad').val(m.id_ciudad);
          $('#txtCiudad').val(m.ciudades);
          $('#txtEspecialidad').val(m.especialidades);
          $('#id_especialidad').val(m.id_especialidad);
          $('#txtregistro').val(m.num_registro);
          $('#modalFormulario').modal('show');
        })
        .catch(err => {
          console.error('Error al cargar médico:', err);
          Swal.fire("Error", "No se pudo cargar el médico", "error");
        });
    });
  };

  const eliminar = () => {
    $('#tbl').on('click', 'button[name="btn_eliminar"]', function() {
      const idMedico = $(this).data('id_medico');
      Swal.fire({
        title: "¿Deseas eliminar este médico?",
        showCancelButton: true,
        confirmButtonText: "Sí",
        cancelButtonText: "No"
      }).then(result => {
        if (result.isConfirmed) {
          fetch(`/api/v1/medico/${idMedico}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          })
          .then(resp => resp.json())
          .then(data => {
            if (data.success) {
              $('#tbl').DataTable().ajax.reload();
              Swal.fire("Eliminado", "El médico ha sido eliminado", "success");
            } else {
              Swal.fire("Error", data.error, "error");
            }
          });
        }
      });
    });
  };

  const addEvents = () => {
    agregar();
    guardar();
    editar();
    eliminar();
    buscarCiudad();
    buscarEspecialidad();
  };

  $(function() {
    initDatatable();
    initDatatablec();
    initDatatablee();
    addEvents();
  });
</script>
{% endblock %}