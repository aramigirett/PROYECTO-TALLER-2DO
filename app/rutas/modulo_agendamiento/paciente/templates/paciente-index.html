{% extends 'base.html' %}

{% block titulo %}
Paciente
{% endblock %}

{% block contenido %}
<div class="container mt-10">
  <h3>Listado de Pacientes</h3>

  <!-- Tarjeta -->
  <div class="card">
    <div class="card-header">
      <button type="button" class="btn btn-outline-primary" id="btnAgregar">Agregar</button>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped" id="tbl">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Cédula</th>
              <th>Fecha Nacimiento</th>
              <th>Teléfono</th>
              <th>Correo</th>
              <th>Ciudad</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- /Tarjeta -->

  <!-- Modal formulario -->
  <div class="modal" id="modalFormulario">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title" id="modalTitle"></h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <input type="hidden" id="txtIdPaciente">
          <input type="hidden" id="id_ciudad">

          <div class="container-fluid">
            <div class="row">
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="nombre">Nombre:</label>
                  <input type="text" class="form-control" placeholder="Ingrese el nombre" id="nombre">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="apellido">Apellido:</label>
                  <input type="text" class="form-control" placeholder="Ingrese el apellido" id="apellido">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="cedula_entidad">Cédula:</label>
                  <input type="text" class="form-control" placeholder="Ingrese la cédula" id="cedula_entidad">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="fecha_nacimiento">Fecha Nacimiento:</label>
                  <input type="date" class="form-control" id="fecha_nacimiento">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="telefono">Teléfono:</label>
                  <input type="text" class="form-control" placeholder="Ingrese el teléfono" id="telefono">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="direccion">Dirección:</label>
                  <input type="text" class="form-control" placeholder="Ingrese la dirección" id="direccion">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="correo">Correo:</label>
                  <input type="email" class="form-control" placeholder="correo@ejemplo.com" id="correo">
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="txtCiudad">Ciudad:</label>
                  <input type="text" class="form-control" placeholder="Seleccione la ciudad" id="txtCiudad" readonly>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="form-group">
                  <label for="fecha_registro">Fecha Registro:</label>
                  <input type="text" class="form-control" id="fecha_registro" readonly>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Buscar Ciudad -->
  <div class="modal fade" id="modalBuscarCiudad" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Ciudad</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblCiudad">
              <thead>
                <tr>
                  <th>Ciudad</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

{% endblock %}

{% block js %}
<script>
const initDatatable = () => {
  $('#tbl').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: {
      url: '/api/v1/pacientes',
      dataSrc: 'data'
    },
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: 'cedula_entidad' },
      { data: 'fecha_nacimiento' },
      { data: 'telefono' },
      { data: 'correo' },
      { data: 'ciudades' },
      {
        data: null,
        render: (data, type, row) => `
          <button type="button" class="btn btn-info btn-sm btn-editar" data-id="${row.id_paciente}">
            <i class="fas fa-edit"></i>
          </button>
          <button type="button" class="btn btn-danger btn-sm btn-eliminar" data-id="${row.id_paciente}">
            <i class="fas fa-trash-alt"></i>
          </button>`
      }
    ]
  });
};

const initDatatableCiudad = () => {
  $('#tblCiudad').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: {
      url: '/api/v1/ciudades',
      dataSrc: 'data'
    },
    columns: [
      { data: 'descripcion' },
      {
        data: row => `<button type="button" name="btn_seleccionar_ciudad" class="btn btn-primary"
                      data-id="${row.id_ciudad}" data-ciudad="${row.descripcion}">Seleccionar</button>`
      }
    ]
  });

  $('#tblCiudad').on('click', 'button[name="btn_seleccionar_ciudad"]', function() {
    const idCiudad = $(this).data('id');
    const ciudad = $(this).data('ciudad');
    $('#txtCiudad').val(ciudad);
    $('#id_ciudad').val(idCiudad);
    $('#modalBuscarCiudad').modal('hide');
  });
};

const buscarCiudad = () => {
  $('#txtCiudad').on('click', function() {
    $('#modalBuscarCiudad').modal('show');
  });
};

const agregar = () => {
  $('#btnAgregar').on('click', function() {
    $('#modalTitle').text("Agregar Paciente");
    $('#txtIdPaciente').val("");
    $('#nombre, #apellido, #cedula_entidad, #telefono, #direccion, #correo, #txtCiudad').val("");
    const now = new Date();
    const fechaRegistro = now.getFullYear() + '-' +
      String(now.getMonth() + 1).padStart(2, '0') + '-' +
      String(now.getDate()).padStart(2, '0') + ' ' +
      String(now.getHours()).padStart(2, '0') + ':' +
      String(now.getMinutes()).padStart(2, '0') + ':' +
      String(now.getSeconds()).padStart(2, '0');
    $('#fecha_registro').val(fechaRegistro);
    $('#modalFormulario').modal('show');
  });
};

const guardar = () => {
  $('#btnGuardar').on('click', function() {
    const id_paciente = Number($('#txtIdPaciente').val()) || 0;
    const data = {
      nombre: $('#nombre').val().trim(),
      apellido: $('#apellido').val().trim(),
      cedula_entidad: $('#cedula_entidad').val().trim(),
      fecha_nacimiento: $('#fecha_nacimiento').val(),
      telefono: $('#telefono').val().trim(),
      direccion: $('#direccion').val().trim(),
      correo: $('#correo').val().trim(),
      id_ciudad: $('#id_ciudad').val(),
      fecha_registro: $('#fecha_registro').val()
    };
    const tabla = $('#tbl').DataTable();
    const url = id_paciente > 0 ? `/api/v1/pacientes/${id_paciente}` : '/api/v1/pacientes';
    const method = id_paciente > 0 ? 'PUT' : 'POST';

    fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
      .then(resp => resp.json())
      .then(result => {
        if (result.success) {
          tabla.ajax.reload(null, false);
          Swal.fire("Éxito", id_paciente ? "Paciente actualizado" : "Paciente registrado", "success");
          $('#modalFormulario').modal('hide');
        } else {
          Swal.fire("Error", result.error, "error");
        }
      })
      .catch(() => Swal.fire("Error", "Ocurrió un error al guardar.", "error"));
  });
};

const editar = () => {
  $('#tbl').on('click', '.btn-editar', function() {
    const id_paciente = $(this).data('id');
    fetch(`/api/v1/pacientes/${id_paciente}`)
      .then(resp => resp.json())
      .then(result => {
        if (result.success) {
          const p = result.data;
          $('#txtIdPaciente').val(p.id_paciente);
          $('#nombre').val(p.nombre);
          $('#apellido').val(p.apellido);
          $('#cedula_entidad').val(p.cedula_entidad);
          $('#fecha_nacimiento').val(p.fecha_nacimiento);
          $('#telefono').val(p.telefono);
          $('#direccion').val(p.direccion);
          $('#correo').val(p.correo);
          $('#id_ciudad').val(p.id_ciudad);
          $('#txtCiudad').val(p.ciudades);
          $('#fecha_registro').val(p.fecha_registro);
          $('#modalTitle').text("Editar Paciente");
          $('#modalFormulario').modal('show');
        } else {
          Swal.fire("Error", result.error, "error");
        }
      });
  });
};

const eliminar = () => {
  $('#tbl').on('click', '.btn-eliminar', function() {
    const id_paciente = $(this).data('id');
    const tabla = $('#tbl').DataTable();
    Swal.fire({
      title: "¿Eliminar paciente?",
      text: "Esta acción no se puede deshacer.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Sí, eliminar",
      cancelButtonText: "Cancelar"
    }).then(result => {
      if (result.isConfirmed) {
        fetch(`/api/v1/pacientes/${id_paciente}`, { method: 'DELETE' })
          .then(resp => resp.json())
          .then(result => {
            if (result.success) {
              tabla.ajax.reload(null, false);
              Swal.fire("Eliminado", "El paciente fue eliminado correctamente.", "success");
            } else {
              Swal.fire("Error", result.error, "error");
            }
          });
      }
    });
  });
};

// Validación: solo números
$('#telefono, #cedula_entidad').on('input', function() {
  this.value = this.value.replace(/[^0-9]/g, '');
});

$(function() {
  initDatatable();
  initDatatableCiudad();
  buscarCiudad();
  agregar();
  guardar();
  editar();
  eliminar();
});
</script>
{% endblock %}